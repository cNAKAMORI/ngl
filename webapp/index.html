<!DOCTYPE html>
<html lang="en">
<head>
  <title>NGL - webapp</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" href="css/font-awesome.min.css" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="subresource" href="css/light.css" />
  <link rel="subresource" href="css/dark.css" />
</head>
<body>
  <!-- NGL -->
  <script src="../build/js/ngl.dev.js"></script>

  <!-- UI -->
  <script src="js/lib/signals.min.js"></script>
  <script src="js/lib/tether.min.js"></script>
  <script src="js/lib/colorpicker.min.js"></script>
  <script src="js/ui/ui.js"></script>
  <script src="js/ui/ui.extra.js"></script>
  <script src="js/ui/ui.ngl.js"></script>
  <script src="js/gui.js"></script>

  <script>
    NGL.cssDirectory = "css/"
    NGL.documentationUrl = "../build/docs/"
    NGL.repListUrl = "./scripts/representation/repList.json"
    NGL.repScriptUrl = "./scripts/representation/"
    NGL.functionListUrl = "./scripts/function/functionList.json"
    NGL.functionScriptUrl = "./scripts/function/"
    
    // Datasources
    NGL.DatasourceRegistry.add("data", new NGL.StaticDatasource("../data/"))
    var mdsrv = NGL.getQuery("mdsrv")
    if (mdsrv) {
      var mdsrvDatasource = new NGL.MdsrvDatasource(mdsrv)
      NGL.DatasourceRegistry.add("file", mdsrvDatasource)
      NGL.setListingDatasource(mdsrvDatasource)
      NGL.setTrajectoryDatasource(mdsrvDatasource)
    }

    var stage
    document.addEventListener("DOMContentLoaded", function () {
      stage = new NGL.Stage()
      NGL.StageWidget(stage)
      let query = window.location.search.slice(1)
      let dq = {}
      if (query) {
        query.split("&").forEach(function(q) {
          let qa = q.split("=")
          dq[qa[0]] = qa[1]
        })
      }
      
      if(dq["file"]){
        stage.loadFile(dq["file"],{defaultRepresentation: true}).then(function (c) {
          if(dq["repr"]=="alphafold"){
            c.setSelection('')
            c.removeAllRepresentations()
            c.addRepresentation('cartoon', {
              colorDomain: [0, 49.999, 50, 69.999, 70, 89.999, 90, 100],
              colorScale: ['#ff7d45', '#ff7d45', '#ffdb13', '#ffdb13', '#65cbf3', '#65cbf3', '#0053d6', '#0053d6'],
              colorScheme: 'bfactor'})
          }else if(dq["repr"]=="docking"){
            c.removeAllRepresentations()
            c.setSelection('/0 /1')
            c.addRepresentation("cartoon" , { colorScheme: "chainindex"})
            c.addRepresentation("spacefill", { sele: "ion"})
            c.addRepresentation("ball+stick" , { sele: "not (protein or nucleic or water) and not apolarh", 
            								  multipleBond: "symmetric"})
            c.addRepresentation("line" , { sele: "(protein or nucleic) and not apolarh",
            						       linewidth: 0.75})
            c.addRepresentation("contact"  , { masterModelIndex: 0, 
            							       weakHydrogenBond: true, 
            							       maxHbondDonPlaneAngle: 35,
            							       sele: "not water"})
          }else if(dq["repr"]=="surface"){
            c.removeAllRepresentations()
            c.setSelection('/0 /1')
            c.addRepresentation("cartoon" , { colorScheme: "chainindex"})
            c.addRepresentation("spacefill", { sele: "ion"})
            c.addRepresentation("ball+stick" , { sele: "not (protein or nucleic or water) and not apolarh", 
            								  multipleBond: "symmetric"})
            c.addRepresentation("line" , { sele: "(protein or nucleic) and not apolarh",
            						        linewidth: 0.75})
            c.addRepresentation("contact"  , { masterModelIndex: 0, 
            							       weakHydrogenBond: true, 
            							       maxHbondDonPlaneAngle: 35,
            							       sele: "not water"})
            c.addRepresentation("surface"  , { sele: "(protein or nucleic or ACE or NME) and not HET",
            							       opaqueBack: false,
            							       opacity: 0.67,
            							       color: "hydrophobicity",
            							       surfaceType: "av"})
          }
        })
      }
      
      var load = NGL.getQuery("load")
      if (load) stage.loadFile(load, {defaultRepresentation: true})

      var script = NGL.getQuery("script")
      if (script) stage.loadScript("./scripts/" + script + ".js")

      var struc = NGL.getQuery("struc")
      var traj = NGL.getQuery("traj")
      if (struc) {
        stage.loadFile(struc, {
          defaultRepresentation: true
        }).then(function(o) {
          if (traj) o.addTrajectory(traj)
        })
      }
    })
  </script>
</body>
</html>
